<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title><%= title %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <%-include('nav.ejs')%>
    <div class="container" style="padding: 20px">
      <div>
        <!-- <input type="text" name="name" id="name" placeholder="ì´ë¦„"> -->
        
        <div class="d-grid gap-4">
          <div class="input-group flex-nowrap">
            <span class="input-group-text" id="addon-wrapping">ğŸ§</span>
            <input
              type="text"
              class="form-control"
              value="ë…¸ë˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”."
              aria-label="song"
              aria-describedby="addon-wrapping"
              id="songInput"
              disabled
              required
            />
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#searchModal"
            >
              ë…¸ë˜ ê²€ìƒ‰
            </button>
          </div>

          <div class="input-group flex-nowrap opacity-0" id="nameDiv">
            <span class="input-group-text" id="addon-wrapping">@</span>
            <input type="text" class="form-control" id="name" placeholder="ì‹ ì²­ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." aria-label="Username" aria-describedby="addon-wrapping" required pattern=".*\S.*">
          </div>

        </div>
        <br><br>

        <div style="text-align: center;">
          <input type="submit" value="ë…¸ë˜ ì‹ ì²­"  class="btn btn-outline-secondary" style="display :inline-block;" id="submit"/>
        </div>

      </div>
      <!-- ë…¸ë˜ ê²€ìƒ‰ Modal -->
      <div
        class="modal fade"
        id="searchModal"
        tabindex="-1"
        aria-labelledby="Search Modal"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="searchModalLabel">
                ë…¸ë˜ ê²€ìƒ‰ ğŸ§
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <!-- Modal ë©”ì¸  -->
            <div class="modal-body">
              <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1">ğŸ§</span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="ë…¸ë˜ ì œëª©"
                  aria-label="song"
                  aria-describedby="basic-addon1"
                  id="songSearch"
                />
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="youtubeSearch"
                >
                  ê²€ìƒ‰
                </button>
              </div>
              <div id="songResult" style="text-align: center"></div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // submit button click
      var submit = document.getElementById("submit");

      submit.addEventListener("click", () => {
        var name = document.getElementById("name").value.replace(" ", "");
        if (song === undefined) {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'ë…¸ë˜ë¥¼ ë¨¼ì € ê²€ìƒ‰í•´ì£¼ì„¸ìš”!',
            footer: '<a href="./">ë‹¤ë¥¸ ì˜¤ë¥˜ê°€ ìˆë‚˜ìš”?</a>'
          })
        } else if (name === "") {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'ì´ë¦„ì¹¸ì— ì‹ ì²­ì ì´ë¦„ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!',
            footer: '<a href="./">ë‹¤ë¥¸ ì˜¤ë¥˜ê°€ ìˆë‚˜ìš”?</a>'
          })
        } else {
          fetch(`/users/create?name=${name}&song=${song}&url=${songUrl}`);
          // window.location.replace(`/music?name=${name}&song=${song}&url=${songUrl}`);
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'ì„±ê³µì ìœ¼ë¡œ ë…¸ë˜ë¥¼ ì‹ ì²­í•˜ì˜€ìŠµë‹ˆë‹¤!',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'ë‹«ê¸°',
            footer: '<a href="">ê·¸ ë‹¤ìŒì—” ë­˜ í•´ì•¼í•˜ë‚˜ìš”?</a>'
          }).then((result) => {
            if (result.isConfirmed) {
              location.href = "/";
            }
          })
        };  

      });








      // ë…¸ë˜ ì‹ ì²­ script
      var SearchButton = document.getElementById("youtubeSearch");
      var song;
      var songUrl;
      var name;

      const API_KEY = "AIzaSyAIrylrJj_gzjIGMqDcjCP6fpn9gzkABEA";

    function setData(s, l) {
        song = s;
        songUrl = l;
        var t = document.getElementById("songInput").value = s;
    }

      SearchButton.addEventListener("click", () => {
        var q = document.getElementById("songSearch").value.replace(" ", "+");
        var url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=4&q=${q}&type=video&key=${API_KEY}`;
        var d;
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            d = data.items;
            url: "https://i.ytimg.com/vi/39UIm6GS6TE/default.jpg";

            var songResultDiv = document.getElementById("songResult");
            console.log(d);
            var items = "";
            for (var card in d) {
              var l = d[card].snippet;
              console.log(l);
              var youtubeLink =
                "https://www.youtube.com/watch?v=" +
                l.thumbnails.default.url
                  .replace("https://i.ytimg.com/vi/", "")
                  .replace("/default.jpg", "");
              console.log(youtubeLink);
              var item = `<div class="card" style="width: 20rem; margin: 0 auto;">
                        <img src=${l.thumbnails.default.url} class="card-img-top" alt="...">
                        <div class="card-body">
                            <h7 class="card-title" style="font-weight: bold">${l.title}</h7>
                            <p class="card-text">${l.channelTitle}</p>
                            <button type="button" data-bs-dismiss="modal" class="btn btn-outline-secondary" onclick='song="${l.title}"; songUrl="${youtubeLink}"; document.getElementById("songInput").value = "${l.title}"; document.getElementById("nameDiv").className += " opacity-100 fade show active";' id="modalB">ë…¸ë˜ ì„ íƒ</button>
                        </div>
                    </div>`

                items = items + item;
            }
            songResultDiv.innerHTML = items;
          });
      });
    </script>
  </body>
</html>